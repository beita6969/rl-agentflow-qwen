# AFlow + ROLL 集成训练配置

# 实验配置
exp_name: "aflow_grpo_hybrid_prompts"  # 新版本：混合格式（prompts + graph_code）
output_dir: "checkpoints"
log_dir: "logs"
max_steps: 500  # 总训练步数 (快速更新模式)
save_every: 50  # 每N步保存一次
eval_every: 5  # 每N步评估一次（每5步测试）
log_every: 5    # 每N步记录一次
# resume_from_checkpoint: null  # 从头开始训练新版本
# start_step: 1  # 从Step 1开始

# GRPO算法配置
adv_estimator: "grpo"
num_return_sequences_in_group: 4  # GRPO组大小：每个问题生成4个工作流（从8减小以加快迭代）
ppo_epochs: 1                      # 在线学习：每个batch只训练一次
async_generation_ratio: 0          # 同步模式：0表示完全同步
use_kl_loss: true
kl_loss_coef: 0.001
clip_range: 0.2
gamma: 1.0                         # 折扣因子
lambda_gae: 0.95                   # GAE lambda

# Batch配置 - 快速更新模式: 每batch后立即更新
rollout_batch_size: 4              # 每批问题数 (快速更新: 每16个工作流样本更新一次)
prompt_max_length: 3072            # 增加序列长度
response_max_length: 5120          # 增加输出长度

# 模型配置
base_model: "/home/yijia/verl-agent/models/qwen/Qwen2___5-7B-Instruct"  # 使用本地模型，避免重复下载
model_dtype: "bfloat16"

# LoRA配置 - 方案A: 增加参数量
use_lora: true
lora_rank: 64                      # 从32→64 (4倍参数)
lora_alpha: 64                     # alpha通常等于rank
lora_target_modules: "q_proj,k_proj,v_proj,o_proj"
lora_dropout: 0.05

# 训练参数
learning_rate: 1.0e-5
weight_decay: 0.01
max_grad_norm: 1.0
gradient_accumulation_steps: 2     # 减少累积步数（batch变大了）
warmup_steps: 50
bf16: true
gradient_checkpointing: false      # 与ZeRO-3冲突时禁用

# GPU配置 - 单GPU模式
device_mapping: [0]                # 逻辑设备0（CUDA_VISIBLE_DEVICES=2后对应物理GPU 2）
physical_gpus: [2]                 # 实际使用的物理GPU 2
protected_pids: [3819483]          # 受保护的进程ID
num_gpus: 1                        # 单GPU训练
world_size: 1                      # 单GPU world size

# 数据集配置
data_dir: "data"
train_dataset: "data/train/mixed_dataset.jsonl"
val_dataset: "data/val/mixed_dataset.jsonl"
test_dataset: "data/test/mixed_dataset.jsonl"

# 混合采样比例
domain_ratios:
  math: 0.4      # 40% 数学问题
  code: 0.3      # 30% 代码问题
  qa: 0.3        # 30% QA问题

# AFlow配置
aflow_config_path: "config/aflow_llm.yaml"
aflow_operators: ["Custom", "AnswerGenerate", "Programmer", "ScEnsemble", "Test", "Review", "Revise"]
aflow_operator_descriptions_path: "/home/yijia/.claude/11/AFlow/workspace/MATH/workflows/template/operator.json"
execution_timeout: 180             # 工作流执行超时（秒），从300减小到180以加快失败检测

# 奖励配置
reward_weights:
  correctness: 0.65   # 正确性权重
  efficiency: 0.15    # 效率权重（成本）
  simplicity: 0.10    # 简洁性权重（算子数）
  format: 0.05        # 格式奖励（新增 - ROLL风格）
  repetition: 0.05    # 重复惩罚（新增 - ROLL风格）

# 监控配置
use_wandb: true
wandb_project: "agent-prompt"      # 新项目名称
wandb_entity: "yao110002-sdfsdfsdfsdf-com"  # wandb用户名

# 生成配置
generation_config:
  temperature: 0.1  # 降低以严格遵循提示词（从0.7降低）
  top_p: 0.95
  top_k: 50
  max_new_tokens: 4096
  do_sample: true

# 调试选项
debug: false
verbose: true
