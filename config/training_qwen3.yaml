# AFlow + ROLL 集成训练配置 - Qwen3-8B版本

# 实验配置
exp_name: "aflow_grpo_qwen3"
output_dir: "checkpoints_qwen3"
log_dir: "logs_qwen3"
max_steps: 500  # 总训练步数
save_every: 50  # 每N步保存一次
eval_every: 25  # 每N步评估一次
log_every: 5    # 每N步记录一次

# GRPO算法配置
adv_estimator: "grpo"
num_return_sequences_in_group: 4  # GRPO组大小：每个问题生成4个工作流
ppo_epochs: 1                      # 在线学习：每个batch只训练一次
async_generation_ratio: 0          # 同步模式：0表示完全同步
use_kl_loss: true
kl_loss_coef: 0.001
clip_range: 0.2
gamma: 1.0                         # 折扣因子
lambda_gae: 0.95                   # GAE lambda

# Batch配置 - 方案A: 大幅增加显存使用 (目标: 60-70GB/80GB)
rollout_batch_size: 20             # 每批问题数（实际样本=20*4=80）大幅增加
prompt_max_length: 3072            # 增加序列长度
response_max_length: 5120          # 增加输出长度

# 模型配置 - Qwen3-8B
base_model: "/home/yijia/lhy/Qwen/Qwen3-8B"  # Qwen3-8B模型
model_dtype: "bfloat16"

# LoRA配置 - 方案A: 增加参数量
use_lora: true
lora_rank: 64                      # 从32→64 (4倍参数)
lora_alpha: 64                     # alpha通常等于rank
lora_target_modules: "q_proj,k_proj,v_proj,o_proj"
lora_dropout: 0.05

# 训练参数
learning_rate: 1.0e-5
weight_decay: 0.01
max_grad_norm: 1.0
gradient_accumulation_steps: 2     # 减少累积步数（batch变大了）
warmup_steps: 50
bf16: true
gradient_checkpointing: false      # 与ZeRO-3冲突时禁用

# GPU配置 - 只使用GPU 3
device_mapping: [0]                # 逻辑设备0（CUDA_VISIBLE_DEVICES=3后对应物理GPU 3）
physical_gpus: [3]                 # 实际使用的物理GPU 3
protected_pids: [3819483]          # 受保护的进程ID
num_gpus: 1                        # 单GPU训练
world_size: 1                      # 单GPU world size

# 数据集配置
data_dir: "data"
train_dataset: "data/train/mixed_dataset.jsonl"
val_dataset: "data/val/mixed_dataset.jsonl"
test_dataset: "data/test/mixed_dataset.jsonl"

# 混合采样比例
domain_ratios:
  math: 0.4      # 40% 数学问题
  code: 0.3      # 30% 代码问题
  qa: 0.3        # 30% QA问题

# AFlow配置
aflow_config_path: "config/aflow_llm_qwen3.yaml"  # 使用独立配置(不同API key)
aflow_operators: ["Custom", "AnswerGenerate", "Programmer", "ScEnsemble", "Test", "Review", "Revise"]
aflow_operator_descriptions_path: "/home/yijia/.claude/11/AFlow/workspace/MATH/workflows/template/operator.json"
execution_timeout: 180             # 工作流执行超时（秒）

# 奖励配置
reward_weights:
  correctness: 0.65   # 正确性权重
  efficiency: 0.15    # 效率权重（成本）
  simplicity: 0.10    # 简洁性权重（算子数）
  format: 0.05        # 格式奖励（新增 - ROLL风格）
  repetition: 0.05    # 重复惩罚（新增 - ROLL风格）

# 监控配置
use_wandb: true
wandb_project: "aflow-roll-integration"
wandb_entity: null  # 你的wandb用户名

# 生成配置
generation_config:
  temperature: 0.1  # 降低以严格遵循提示词
  top_p: 0.95
  top_k: 50
  max_new_tokens: 4096
  do_sample: true

# 调试选项
debug: false
verbose: true
